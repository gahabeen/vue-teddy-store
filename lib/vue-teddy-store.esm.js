import{watch as t,reactive as e,isRef as r,ref as n,computed as o}from"@vue/composition-api";var s=Object.freeze(["Couldn't not find any proper value for ",""]),i=/({.+?})/gim;function a(t){return function(e){var r=c(t,e.slice(1,-1).trim());if(["string","number"].includes(typeof r))return r;throw new Error(s,r)()}}function c(t,e,r,n){return String(e).replace(/\[/g,".").replace(/]/g,"").replace(i,a(n)).split(".").reduce((function(t,e){try{t=void 0===t[e]?r:t[e]}catch(t){return r}return t}),t)}var u=function(t){return"teddy:store:"+t},f={handle:function(e){var r=e.name,n=e.store,o=window.localStorage||global.localStorage||{};if(o){var s=o.getItem(u(r));s&&(n._state=Object.assign({},n._state,JSON.parse(s))),t(n._state,(function(t){o.setItem(u(r),JSON.stringify(t))}),{immediate:!0,deep:!0})}}},p={handle:function(r){var n=r.store;n._history=e([]),t(n._state,(function(t){n._history.push(t)}),{immediate:!0,deep:!0})}},h={handle:function(t){var r=t.name,n=t.store;window&&window.addEventListener("storage",(function(t){t.key===u(r)&&(n._state=e(Object.assign({},n._state,JSON.parse(t.newValue))))}))}};function l(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&-1===e.indexOf(n)&&(r[n]=t[n]);return r}function d(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var r=t.find((function(t){return t&&t instanceof y})),n=t.find((function(t){return t&&"$teddy"in t&&t.$teddy instanceof y})),o=r||(n?n.$teddy:void 0);if(!o)throw new Error("Couldn't find any proper instance!");return o}var y=function(){this._stores=e({}),this._plugins=e({cache:f,history:p,sync:h})},g={stores:{configurable:!0}};y.prototype.add=function(r,n){var o,s=this,i=(n._state,n.state,n.methods,n.watchers,l(n,["_state","state","methods","watchers"])),a=y.createState(n._state||n.state||{}),u=a._state,f=a.state;this._stores=Object.assign({},this._stores,((o={})[r]=e(Object.assign({},{_state:u,state:f},n.methods||{},i)),o));var p=[];for(var h of(Array.isArray(n.watchers)?p.push.apply(p,n.watchers):n.watcher&&p.push(n.watcher),p))if("function"==typeof h)t(this._stores[r].state,h,{deep:!0});else if(h&&"object"==typeof h&&"handler"in h){var d=h.handler,g=h.path,v=h.paths;void 0===v&&(v=[]);var _=l(h,["handler","path","paths"]);g?t((function(){return c(s._stores[r].state,g)}),d,Object.assign({},{deep:!0},_)):v.length>0?t(v.map((function(t){return function(){return c(s._stores[r].state,t)}})),d,Object.assign({},{deep:!0},_)):t((function(){return s._stores[r].state}),d,Object.assign({},{deep:!0},_))}return this},y.prototype.use=function(t){var e=this;return void 0===t&&(t={}),"function"==typeof t.install&&t.install(this),"function"==typeof t.handle&&Object.keys(this._stores).map((function(r){return t.handle.call(e,{name:r,store:e._stores[r]})})),this},y.prototype.activate=function(t){for(var e of(void 0===t&&(t=[]),Array.isArray(t)||(t=[t]),t))e in this._plugins&&this.use(this._plugins[e]);return this},y.prototype.install=function(t){t.prototype.$Teddy=y,t.prototype.$teddy=this},g.stores.get=function(){return this._stores},y.createState=function(t){void 0===t&&(t={});var e=r(t)?t:n(t),s=o((function(){return e.value}));return{_state:e,state:s}},y.prototype.get=function(t,e){return y.get.call(this,t,e)},y.get=function(t,e,r){return r=r||this,function(){var n=d(this,r);try{return c(n.stores[t].state,e,void 0,r)}catch(r){throw new Error("Couldn't compute (get) path '"+e+"' for '"+t+"'")}}},y.prototype.set=function(t,e){return y.set.call(this,t,e)},y.set=function(t,e,r){return r=r||this,function(n){var o=d(this,r);try{!function(t,e,r,n){var o=String(e).replace(/\[/g,".").replace(/]/g,"").replace(i,a(n)).split("."),s=function(t){return t.replace(/^\^/,"")},c=function(t,e,r){var n=e.shift();if(e.length>0){if(Number.isInteger(+e[0]))return t[n]=[],c(t[n],e,r);if(!t[n])return t[s(n)]={},c(t[s(n)],e,r)}else t[s(n)]=r};c(t,o,r)}(o.stores[t]._state,e,n,r)}catch(r){throw new Error("Couldn't compute (set) path '"+e+"' for '"+t+"'")}}},y.prototype.compute=function(t,e){return y.compute.call(this,t,e)},y.compute=function(t,e){return{get:y.get.call(this,t,e),set:y.set.call(this,t,e)}},Object.defineProperties(y.prototype,g);export default y;
