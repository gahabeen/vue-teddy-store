/*!
  * vue-teddy-store v0.1.24
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.1.24
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import{watch as t,reactive as e,isRef as r,ref as n}from"@vue/composition-api";const s=t=>"teddy:store:"+t;var i={handle({name:e,store:r}){const n=window.localStorage||global.localStorage||{};if(n){const i=n.getItem(s(e));i&&(r.state={...r.state,...JSON.parse(i)}),t(r.state,(t,r)=>{t!==r&&n.setItem(s(e),JSON.stringify(t))},{immediate:!0,deep:!0})}}},o={handle({store:r}){r._history=e([]),t(r.state,t=>{r._history.push(t)},{immediate:!0,deep:!0})}},a={handle({name:t,store:r}){window&&window.addEventListener("storage",n=>{n.key===s(t)&&(r.state=e({...r.state,...JSON.parse(n.newValue)}))})}},c=Object.freeze({__proto__:null,cache:i,history:o,sync:a});const u=/({.+?})/gim,l=/('.+?')/gim;function h(t,e){return r=>{const n=r.replace(/>/gim,".").slice(1,-1).trim();if(n.includes(":")){const r=n.split(":").filter(Boolean).map(t=>t.trim()).map(r=>r.match(l)?r.slice(1,-1).trim():h(t,e)(`{${r}}`));if(2===r.length){const[t,s]=r,i=function(t,e,r){for(let n of Object.keys(t))if(f(t[n])&&t[n][e]==r)return n}(e,t,s);if(void 0!==i)return i;throw new Error(`Couldn't not find any proper variablePath for ${n} and ${r}`)}throw new Error("Couldn't not find any proper keyValue for "+n)}{const e=y(t,n);if(["string","number"].includes(typeof e))return e;throw new Error(`Couldn't not find any proper value for ${e} at ${n}`)}}}function f(t){let e,r;function n(t){return"[object Object]"===Object.prototype.toString.call(t)}return!1!==n(t)&&(e=t.constructor,void 0===e||(r=e.prototype,!1!==n(r)))}function p(t){if(!f(t)||f(t)&&!("value"in t))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(t,"value").get}function d(t,e){return!(!f(t)&&!Array.isArray(t))&&(!(!p(t)||!(e in t.value))||e in t)}function g(t,e){if(f(t)||Array.isArray(t))return p(t)?e&&e in t.value?t.value[e]:t.value:e&&e in t?t[e]:t}function y(t,e,r){return function t(e,n){if(!(n.length>0))return e;{const s=n.shift().replace(u,h(r,e));if(d(e,s)){return t(g(e,s),n)}}}(t,String(e).replace(/\[/g,".").replace(/]/g,"").replace(u,(function(t){return t.replace(/\./gim,">")})).split("."))}function m(t,e,r){return p(t)&&e in t.value?(t.value[e]=r,t.value[e]):(t[e]=r,t[e])}function _(t){const e=t.filter(t=>t&&f(t)&&t instanceof b),r=t.filter(t=>t&&f(t)&&"$teddy"in t&&t.$teddy instanceof b),n=t.filter(t=>!e.includes(t)&&!r.includes(t));return{instances:e,hosted:r,others:n}}function v(...t){const{instances:e,hosted:r}=_(t),n=[...e,...r.map(t=>t.$teddy)];if(0===!e.length)throw new Error("Couldn't find any proper instance!");return n[0]}function w(...t){const{hosted:e,others:r}=_(t),n=[...e,...r];if(0===!n.length)throw new Error("Couldn't find any proper context!");return n[0]}class b{constructor(){this._stores={},this._plugins=c}add(e,r){const n=function(t,e=[]){return Object.keys(t).reduce((r,n)=>(n.includes(e)||(r[n]=t[n]),r),{})}(r,["state","methods","watchers"]);this._stores[e]={...b.createState(r.state),...r.methods||{},...n},this[e]=this._stores[e];const s=[];Array.isArray(r.watchers)?s.push(...r.watchers):r.watcher&&s.push(r.watcher);for(let r of s)if("function"==typeof r)t(()=>this._stores[e].state.value,r,{deep:!0});else if(r&&"object"==typeof r&&"handler"in r){const{handler:n,path:s,paths:i=[],...o}=r;s?t(()=>y(this._stores[e].state.value,s),n,{deep:!0,...o}):i.length>0?t(i.map(t=>()=>y(this._stores[e].state.value,t)),n,{deep:!0,...o}):t(()=>this._stores[e].state.value,n,{deep:!0,...o})}return this}remove(t){t in this&&delete this[t],t in this._stores&&delete this._stores[t]}use(t={}){return"function"==typeof t.install&&t.install(this),"function"==typeof t.handle&&Object.keys(this._stores).map(e=>t.handle.call(this,{name:e,store:this._stores[e]})),this}activate(t=[]){Array.isArray(t)||(t=[t]);for(let e of t)e in this._plugins&&this.use(this._plugins[e]);return this}install(t){t.prototype.$teddy=this}get stores(){return this._stores}static createState(t){return r(t)?t:n(t)}get(t,e){return b.get(t,e,this)}static get(t,e,r){return y(v(this,r),`_stores.${t}.state.${e}`,w(this,r))}getter(t,e){return b.getter(t,e,this)}static getter(t,e,r){return r=r||this,function(){return b.get.call(this,t,e,r)}}set(t,e,r){return b.set(t,e,r,this)}static set(t,e,r,n){!function(t,e,r,n){const s=String(e).replace(/\[/g,".").replace(/]/g,"").replace(u,(function(t){return t.replace(/\./gim,">")})).split("."),i=(t,e,r)=>{const s=(o=e.shift(),o.replace(/^\^/,"")).replace(u,h(n,t));var o;if(e.length>0){const o=e[0].replace(u,h(n,g(t,s)));if(Number.isInteger(+o)){if(!d(t,s)||!Array.isArray(g(t,s)))return i(m(t,s,[]),e,r);i(g(t,s),e,r)}else{if(!d(t,s)||!f(g(t,s)))return i(m(t,s,{}),e,r);i(g(t,s),e,r)}}else m(t,s,r)};s.length>0?i(t,s,r):t.value?t.value=r:t=r}(v(this,n),`_stores.${t}.state.${e}`,r,w(this,n))}setter(t,e){return b.setter(t,e,this)}static setter(t,e,r){return r=r||this,function(n){b.set.call(this,t,e,n,r)}}compute(t,e){return b.compute(t,e,this)}static _compute(t,e,r){r=r||this;return{get:b.getter(t,e,r),set:b.setter(t,e,r)}}static compute(t,e,r){return r=r||this,f(e)?Object.keys(e).reduce((n,s)=>(n[s]=b._compute(t,e[s],r),n),{}):b._compute(t,e,r)}}export default b;
