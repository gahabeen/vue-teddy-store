/*!
  * vue-teddy-store v0.1.21
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.1.21
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import{watch as t,reactive as e,isRef as r,ref as n}from"@vue/composition-api";const s=t=>"teddy:store:"+t;var i={handle({name:e,store:r}){const n=window.localStorage||global.localStorage||{};if(n){const i=n.getItem(s(e));i&&(r.state={...r.state,...JSON.parse(i)}),t(r.state,(t,r)=>{t!==r&&n.setItem(s(e),JSON.stringify(t))},{immediate:!0,deep:!0})}}},o=Object.freeze({__proto__:null,prefix:s,default:i}),a={handle({store:r}){r._history=e([]),t(r.state,t=>{r._history.push(t)},{immediate:!0,deep:!0})}},u=Object.freeze({__proto__:null,default:a}),c={handle({name:t,store:r}){window&&window.addEventListener("storage",n=>{n.key===s(t)&&(r.state=e({...r.state,...JSON.parse(n.newValue)}))})}},l=Object.freeze({__proto__:null,default:c}),h=Object.freeze({__proto__:null,cache:o,history:u,sync:l});const f=/({.+?})/gim;function p(t){return e=>{e=e.slice(1,-1).trim();const r=m(t,e);if(["string","number"].includes(typeof r))return r;throw new Error(`Couldn't not find any proper value for ${r} at ${e}`)}}function d(t){let e,r;function n(t){return"[object Object]"===Object.prototype.toString.call(t)}return!1!==n(t)&&(e=t.constructor,void 0===e||(r=e.prototype,!1!==n(r)))}function y(t){if(!d(t)||d(t)&&!("value"in t))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(t,"value").get}function _(t,e){return!(!d(t)&&!Array.isArray(t))&&(!(!y(t)||!(e in t.value))||e in t)}function g(t,e){if(d(t)||Array.isArray(t))return y(t)?e&&e in t.value?t.value[e]:t.value:e&&e in t?t[e]:t}function m(t,e,r,n){return function t(e,r,n){if(r.length>0){const s=r.shift();if(_(e,s)){return t(g(e,s),r,n)}return n}return e}(t,String(e).replace(/\[/g,".").replace(/]/g,"").replace(f,p(n)).split("."),r)}function v(t,e,r){return y(t)&&e in t.value?(t.value[e]=r,t.value[e]):(t[e]=r,t[e])}function w(t){const e=t.filter(t=>t&&d(t)&&t instanceof j),r=t.filter(t=>t&&d(t)&&"$teddy"in t&&t.$teddy instanceof j),n=t.filter(t=>!e.includes(t)&&!r.includes(t));return{instances:e,hosted:r,others:n}}function b(...t){const{instances:e,hosted:r}=w(t),n=[...e,...r.map(t=>t.$teddy)];if(0===!e.length)throw new Error("Couldn't find any proper instance!");return n[0]}function O(...t){const{hosted:e,others:r}=w(t),n=[...e,...r];if(0===!n.length)throw new Error("Couldn't find any proper context!");return n[0]}class j{constructor(){this._stores={},this._plugins=h}add(e,r){const n=function(t,e=[]){return Object.keys(t).reduce((r,n)=>(n.includes(e)||(r[n]=t[n]),r),{})}(r,["state","methods","watchers"]);this._stores[e]={...j.createState(r.state),...r.methods||{},...n};const s=[];Array.isArray(r.watchers)?s.push(...r.watchers):r.watcher&&s.push(r.watcher);for(let r of s)if("function"==typeof r)t(()=>this._stores[e].state.value,r,{deep:!0});else if(r&&"object"==typeof r&&"handler"in r){const{handler:n,path:s,paths:i=[],...o}=r;s?t(()=>m(this._stores[e].state.value,s),n,{deep:!0,...o}):i.length>0?t(i.map(t=>()=>m(this._stores[e].state.value,t)),n,{deep:!0,...o}):t(()=>this._stores[e].state.value,n,{deep:!0,...o})}return this}use(t={}){return"function"==typeof t.install&&t.install(this),"function"==typeof t.handle&&Object.keys(this._stores).map(e=>t.handle.call(this,{name:e,store:this._stores[e]})),this}activate(t=[]){Array.isArray(t)||(t=[t]);for(let e of t)e in this._plugins&&this.use(this._plugins[e]);return this}install(t){t.prototype.$teddy=this}get stores(){return this._stores}static createState(t){return r(t)?t:n(t)}get(t,e){return j.get(t,e,this)}static get(t,e,r){return r=r||this,function(){const n=b(this,r),s=O(this,r);return m(n,`_stores.${t}.state.${e}`,void 0,s)}}set(t,e){return j.set(t,e,this)}static set(t,e,r){return r=r||this,function(n){const s=b(this,r),i=O(this,r);!function(t,e,r,n){const s=String(e).replace(/\[/g,".").replace(/]/g,"").replace(f,p(n)).split("."),i=(t,e,r)=>{const n=e.shift().replace(/^\^/,"");if(e.length>0){const s=e[0];if(Number.isInteger(+s)){if(!_(t,n)||!Array.isArray(g(t,n)))return i(v(t,n,[]),e,r);i(g(t,n),e,r)}else{if(!_(t,n)||!d(g(t,n)))return i(v(t,n,{}),e,r);i(g(t,n),e,r)}}else v(t,n,r)};s.length>0?i(t,s,r):t.value?t.value=r:t=r}(s,`_stores.${t}.state.${e}`,n,i)}}compute(t,e){return j.compute(t,e,this)}static _compute(t,e,r){r=r||this;return{get:j.get(t,e,r),set:j.set(t,e,r)}}static compute(t,e,r){return r=r||this,d(e)?Object.keys(e).reduce((n,s)=>(n[s]=j._compute(t,e[s],r),n),{}):j._compute(t,e,r)}}export default j;
