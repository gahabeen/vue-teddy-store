/*!
  * vue-teddy-store v0.2.38
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.2.38
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import e,{reactive as t,unref as s,isRef as r,ref as n,provide as a,inject as o,computed as c,watch as i}from"@vue/composition-api";import{isObject as p,makeSet as u,makeHas as l,makeGet as d,makeRemove as f,isValidKey as y}from"object-string-path";import h from"object-hash";import m from"fast-safe-stringify";import g from"vue";const v=(e,t)=>`teddy:${e}:${t}`;var S={store(e,t){const s=me({space:e,name:t});if(s.features.cache)return;const r=window.localStorage||global.localStorage||{};if(r){const n=r.getItem(v(e,t));n&&(s.state=JSON.parse(n)),te({space:e,name:t},{handler(s){r.setItem(v(e,t),JSON.stringify(s))},immediate:!0,deep:!0}),s.features.cache=!0}}},P={store(e,s){const r=me({space:e,name:s});r.features.history||(r.features.history={},r.features.history.stack=t([]),te({space:e,name:s},{handler(e){r.features.history.stack.push({state:e,ts:(new Date).getTime()})},immediate:!0,deep:!0}),r.features.history.installed=!0)}},b={store(e,t){const s=me({space:e,name:t});s.features.sync||(s.features.sync={},window&&window.addEventListener("storage",e=>{e.key===v(t)&&(s.state={...s.state,...JSON.parse(e.newValue)})}),s.features.sync.installed=!0)}},j=Object.freeze({__proto__:null,cache:S,history:P,sync:b});function w(e){if(!p(e)||p(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}const O={},_=(e,t)=>(r,n=[],a={},o={},c=(()=>null))=>{const{value:i}=((e,t)=>(r,n=[],a={},o={},c=(()=>null))=>{const i=n.join("."),p=h(JSON.parse(m(r,s))),u=h(JSON.parse(m(o,s))),l=`${e}/${t}//${i}//${u}`;if(p in O&&O[p].has(l))return{cache:!0,value:O[p].get(l)};{p in O||(O[p]=new Map);const e=c(r,n,a);return O[p].set(l,e),{cache:!1,value:e}}})(e,t)(r,n,a,o,c);return i};function k(e,t,s){return y(t)&&(p(e)||Array.isArray(e))?w(e)&&"value"in e&&t in e.value?(e.value[t]=s,e.value[t]):Array.isArray(e)?(e.splice(+t,1,s),e[t]):p(e)?(e[t]=s,e[t]):void 0:e&&null==t?(w(e)&&"value"in e?e.value=s:p(s)?Object.assign(e,s):e=s,e):void console.warn("Couldn't not set "+t)}function A(e,t){return y(t)?w(e)?t in e.value?e.value[t]:e.value:p(e)||Array.isArray(e)?e[t]:void 0:e&&void 0===t?w(e)?e.value:e:void 0}function $(e,t){return!(!p(e)&&!Array.isArray(e))&&(!!y(t)&&(!!(w(e)&&e.value&&t in e.value)||(!(!e||!(t in e))||void 0)))}function G(e,t,n,a){const o=s(t),c=r(t);return Array.isArray(o)?(c?t.value.splice(+a,1):t.splice(+a,1),!0):!!p(o)&&(c?t.value=function(e,t=[]){return Object.keys(e).reduce((s,r)=>(t.includes(r)||(s[r]=e[r]),s),{})}(t.value,[a]):delete t[a],n.length,!0)}function T(e=[]){return"_state"!==e[0]?["_state",...e]:e}const J=u({setProp:k,getProp:A,hasProp:$,afterGetSteps:T}),N=l({getProp:A,hasProp:$,afterGetSteps:T}),x=(e,t)=>d({getProp:A,hasProp:$,afterGetSteps:T,proxy:_(e,t)}),W=(e,t)=>f({get:x(e,t),getProp:A,hasProp:$,removeProp:G,afterGetSteps:T}),z=u({setProp:k,getProp:A,hasProp:$}),C=l({getProp:A,hasProp:$}),D=d({getProp:A,hasProp:$}),I=f({get:D,getProp:A,hasProp:$});var M=Object.freeze({__proto__:null,teddySet:J,teddyHas:N,teddyGet:x,teddyRemove:W,set:z,has:C,get:D,remove:I});g.use(e);const B=Symbol(),E=Symbol(),F={__options:{devtools:!0},spaces:{}},H="$",L="@",R=e=>{let t,s;if(p(e))t="space"in e?e.space:H,s="name"in e?e.name:L;else if("string"==typeof e)if(e.includes(".")){let[r,n]=e.split(".");t=r,s=n}else if(e.includes("/")){let[r,n]=e.split("/");t=r,s=n}else t=H,s=e;return"string"==typeof t&&(t=t.trim(),0===t.length&&(t=void 0)),"string"==typeof s&&(s=s.trim(),0===s.length&&(s=void 0)),{space:t,name:s}},V=(e,t)=>{const s=R(e);t=t||{};const r=me(s);return Q(s,t.state),X(s,t.getters),Z(s,t.actions),te(s,t.watchers),r},q=(e,t)=>r(t)?t:n(t),K=(e,t,s={})=>(s._state=q(0,t),"state"in s||Object.defineProperty(s,"state",{get:()=>s._state.value,set:e=>{s._state.value=e},enumerable:!0}),s),Q=(e,t)=>{const s=me(e);K(0,t,s)},U=(e,t)=>{const s=me(e);return t=t||{},Object.keys(t).reduce((e,r)=>(w(t[r])?e[r]=t[r]:"function"==typeof t[r]&&(e[r]=be(()=>t[r](s))),e),{})},X=(e,t)=>{const s=me(e);return s.getters={...s.getters||{},...U(e,t)},s},Y=(e,t)=>{const s=me(e);return t=t||{},Object.keys(t).reduce((e,r)=>("function"==typeof t[r]&&(e[r]=(...e)=>t[r](s,...e)),e),{})},Z=(e,t)=>{const s=me(e);return s.actions={...s.actions||{},...Y(e,t)},s},ee=(e,t)=>{const{space:s,name:r}=R(e),n=me(e),a=[];return Array.isArray(t)?a.push(...t):t&&a.push(t),0===a.length?[]:a.reduce((e,t)=>{const a=(t,s,r,n)=>{const a=i(s,r,{deep:!0,...n});e.push({path:t,handler:r,options:n,unwatch:a})};if("function"==typeof t)a("state",()=>n.state,t,{deep:!0});else if(t&&"object"==typeof t&&"handler"in t){const{handler:e,path:o,paths:c=[],...i}=t,p=e=>function(t,s){(void 0!==t&&void 0!==s||t!==s)&&e.call(this,t,s)};"string"==typeof o?a(o,()=>x(s,r)(n,o),p(e),{deep:!0,...i}):c.length>0?a(c.map(e=>[r,e].filter(Boolean).filter(e=>e.length>0).join(".")),c.map(e=>()=>x(s,r)(n,e)),p(e),{deep:!0,...i}):a("state",()=>n.state,p(e),{deep:!0,...i})}return e},[])},te=(e,t)=>{const s=me(e);return s.watchers=[...s.watchers||[],...ee(e,t)],s},se=e=>{const{space:t,name:s}=R(e);return void 0!==s?t in F.spaces&&"stores"in F.spaces[t]&&s in F.spaces[t].stores:t in F.spaces},re=e=>{},ne=(e,t,...s)=>{const{store:r}=ge(e);if(t in r.actions)try{return r.actions[t](...s)}catch(e){console.error(`Something went wrong with the action '${t}'`),console.error(e)}else console.warn(`Couldn't find the action '${t}' to run.`)},ae=(e,t,s)=>{const{space:r,name:n}=R(e),a=me({space:r,name:n});return W(r,n)(a,t,s)},oe=(e,t,s)=>{const r=me(e);return N(r,t,s)},ce=(e,t,s,r)=>{const{space:n,name:a}=R(e),o=me({space:n,name:a});return x(n,a)(o,t,s)||r},ie=(e,t,s,r)=>function(){return ce(e,t,s||this,r)},pe=(e,t,s,r)=>{const n=me(e);J(n,t,s,r)},ue=(e,t,s)=>function(r){pe(e,t,r,s||this)},le=(e,t,s)=>{const r=(t,s)=>({get:ie(e,t,s),set:ue(e,t,s)});return Array.isArray(t)?t.reduce((e,t)=>(e[t]=r(t,s),e),{}):p(t)?Object.keys(t).reduce((e,n)=>(e[n]=r(t[n],s),e),{}):r(t,s)},de=(e={})=>{"function"==typeof e.teddy&&e.teddy(F);for(const t of Object.keys(F.spaces||{})){"function"==typeof e.space&&e.space(t);for(const s of Object.keys(F.spaces[t].stores||{}))"function"==typeof e.store&&e.store(t,s)}},fe=(e=(e=>e))=>({setStore:e(V),makeState:e(q),setState:e(Q),applyState:e(K),makeGetters:e(U),setGetters:e(X),makeActions:e(Y),setActions:e(Z),makeWatchers:e(ee),setWatchers:e(te),exists:e(se),reset:e(re),run:e(ne),remove:e(ae),has:e(oe),get:e(ce),getter:e(ie),set:e(pe),setter:e(ue),sync:e(le)}),ye=(e=H)=>(e in F.spaces||(F.spaces[e]={}),F.spaces[e]),he=(e=H)=>({store:ye(e),...fe(t=>(...s)=>t({space:e,name:L},...s))}),me=e=>{const{space:t=H,name:s=L}=R(e);return ye(t),"stores"in F.spaces[t]||(F.spaces[t].stores={}),s in F.spaces[t].stores||(F.spaces[t].stores[s]={getters:{},actions:{},watchers:[],options:{},features:{}},K(0,{},F.spaces[t].stores[s])),F.spaces[t].stores[s]},ge=e=>({store:me(e),...fe(t=>(...s)=>t(e,...s))}),ve=e=>{a(E,ge(e))},Se=()=>{o(B)},Pe=()=>{o(E)},be=e=>{if(p(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?c(e):Object.keys(e).reduce((t,s)=>(t[s]=c(e[s]),t),{})}return c(e)};var je=Object.freeze({__proto__:null,accessors:M,features:j,Teddy:B,TeddyStore:E,Teddies:F,setStore:V,makeState:q,applyState:K,setState:Q,makeGetters:U,setGetters:X,makeActions:Y,setActions:Z,makeWatchers:ee,setWatchers:te,exists:se,reset:re,run:ne,remove:ae,has:oe,get:ce,getter:ie,set:pe,setter:ue,sync:le,setFeature:de,mapMethods:fe,getTeddy:ye,useTeddy:he,getStore:me,useStore:ge,provideTeddyStore:ve,injectTeddy:Se,injectTeddyStore:Pe,computed:be});const we=e=>{e.prototype.$teddy=je};export{F as Teddies,B as Teddy,E as TeddyStore,M as accessors,K as applyState,be as computed,se as exists,j as features,ce as get,me as getStore,ye as getTeddy,ie as getter,oe as has,Se as injectTeddy,Pe as injectTeddyStore,we as install,Y as makeActions,U as makeGetters,q as makeState,ee as makeWatchers,fe as mapMethods,ve as provideTeddyStore,ae as remove,re as reset,ne as run,pe as set,Z as setActions,de as setFeature,X as setGetters,Q as setState,V as setStore,te as setWatchers,ue as setter,le as sync,ge as useStore,he as useTeddy};
