/*!
  * vue-teddy-store v0.3.0
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.3.0
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import e,{reactive as t,isRef as s,set as r,unref as o,ref as n,provide as a,inject as c,computed as i,watch as p}from"@vue/composition-api";import{isObject as u,makeSet as f,makeHas as h,makeGet as l,makeRemove as d,makePush as y,makeUnshift as g,isValidKey as m}from"object-string-path";import P from"vue";import v from"debounce";import S from"fast-deep-equal";import w from"fn-annotate";const b=(e,t)=>`teddy:${e}:${t}`;var _={store(e,t){const s=je({space:e,name:t});if(s.features.cache)return;const r=window.localStorage||global.localStorage||{};if(r){const o=r.getItem(b(e,t));o&&(s.state=JSON.parse(o)),ie({space:e,name:t},{handler(s){r.setItem(b(e,t),JSON.stringify(s))},immediate:!0,deep:!0}),s.features.cache=!0}}},k={store(e,s){const r=je({space:e,name:s});r.features.history||(r.features.history={},r.features.history.stack=t([]),ie({space:e,name:s},{handler(e){r.features.history.stack.push({state:e,ts:(new Date).getTime()})},immediate:!0,deep:!0}),r.features.history.installed=!0)}},A={store(e,t){const s=je({space:e,name:t});s.features.sync||(s.features.sync={},window&&window.addEventListener("storage",r=>{r.key===b(e,t)&&(s.state={...s.state,...JSON.parse(r.newValue)})}),s.features.sync.installed=!0)}},j=Object.freeze({__proto__:null,cache:_,history:k,sync:A});function O(e){if(!u(e)||u(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}function G(e,t,o){const n=s(e);(function(e){const t=parseFloat(String(e));return t>=0&&Math.floor(t)===t&&isFinite(e)})(t)||m(t)?r(n?e.value:e,t,o):n?e.value=o:e=o}function $(e,t){if(u(e)||Array.isArray(e))return m(t)?s(e)?e.value[t]:e[t]:s(e)?e.value:e}function T(e,t){return!(!u(e)&&!Array.isArray(e))&&(!!m(t)&&(!!(O(e)&&e.value&&t in e.value)||(!(!e||!(t in e))||void 0)))}function W(e,t){const r=o(e),n=s(e);if(Array.isArray(r))return n?[...e.value,t]:[...e,t]}function x(e,t){const r=o(e),n=s(e);if(Array.isArray(r))return n?(e.value.unshift(t),e.value):(e.unshift(t),e)}function z(e=[]){return"_state"!==e[0]?["_state",...e]:e}const F=f({setProp:G,getProp:$,hasProp:T,afterGetSteps:z}),J=h({getProp:$,hasProp:T,afterGetSteps:z}),N=l({getProp:$,hasProp:T,afterGetSteps:z}),C=d({getProp:$,hasProp:T,removeProp:function(e,t){const r=o(e),n=s(e);return Array.isArray(r)?(n?e.value.splice(+t,1):e.splice(+t,1),!0):!!u(r)&&(n?e.value=function(e,t=[]){return Object.keys(e).reduce((s,r)=>(t.includes(r)||(s[r]=e[r]),s),{})}(e.value,[t]):delete e[t],!0)},afterGetSteps:z}),D=y({setProp:G,getProp:$,hasProp:T,pushProp:W,afterGetSteps:z}),I=g({setProp:G,getProp:$,hasProp:T,unshiftProp:x,afterGetSteps:z}),M=f({setProp:G,getProp:$,hasProp:T}),q=h({getProp:$,hasProp:T}),B=l({getProp:$,hasProp:T}),E=d({getProp:$,hasProp:T}),H=y({setProp:G,getProp:$,hasProp:T,pushProp:W}),L=g({setProp:G,getProp:$,hasProp:T,unshiftProp:x});var R=Object.freeze({__proto__:null,teddySet:F,teddyHas:J,teddyGet:N,teddyRemove:C,teddyPush:D,teddyUnshift:I,set:M,has:q,get:B,remove:E,push:H,unshift:L});P.use(e);const U=Symbol(),V=Symbol(),K={__options:{devtools:!0},spaces:{}},Q="$",X="@",Y=e=>{let t,s;if(u(e))t="space"in e?e.space:Q,s="name"in e?e.name:X;else if("string"==typeof e)if(e.includes(".")){let[r,o]=e.split(".");t=r,s=o}else if(e.includes("/")){let[r,o]=e.split("/");t=r,s=o}else t=Q,s=e;return"string"==typeof t&&(t=t.trim(),0===t.length&&(t=void 0)),"string"==typeof s&&(s=s.trim(),0===s.length&&(s=void 0)),{space:t,name:s}},Z=(e,t)=>{const s=Y(e);t=t||{};const r=je(s);return se(s,t.state),oe(s,t.getters),ae(s,t.actions),ie(s,t.watchers),r},ee=(e,t)=>s(t)?t:n(t),te=(e,t,s={})=>(s._state=ee(0,t),"state"in s||Object.defineProperty(s,"state",{get:()=>s._state.value,set:e=>{s._state.value=e},enumerable:!0}),s),se=(e,t)=>{const s=je(e);te(0,t,s)},re=(e,t)=>{const s=je(e);return t=t||{},Object.keys(t).reduce((e,r)=>(O(t[r])?e[r]=t[r]:"function"==typeof t[r]&&(w(t[r]).length>1?e[r]=(...e)=>We(()=>t[r](s,...e)):e[r]=We(()=>t[r](s))),e),{})},oe=(e,t)=>{const s=je(e);return s.getters={...s.getters||{},...re(e,t)},s},ne=(e,t)=>{const s=je(e);return t=t||{},Object.keys(t).reduce((e,r)=>("function"==typeof t[r]&&(e[r]=(...e)=>t[r](s,...e)),e),{})},ae=(e,t)=>{const s=je(e);return s.actions={...s.actions||{},...ne(e,t)},s},ce=(e,t)=>{const{name:s}=Y(e),r=je(e),o=[];return Array.isArray(t)?o.push(...t):t&&o.push(t),0===o.length?[]:o.reduce((e,t)=>{const o=(e,t=null)=>{const s=function(t,s){e.call(this,t,s,S(t,s))};return"number"==typeof t?v(s,t,!0):s},n=(e="",t)=>`${e}||${t.toString()}`,a=(t,s,r,a={})=>{e.push({path:t,signature:n(t,r),options:a,start(){return this.unwatch=p(s,o(r,a.debounce),{deep:!0,...a}),this}})};if("function"==typeof t)a("state",()=>r.state,t,{deep:!0});else if(t&&"object"==typeof t&&"handler"in t){const{handler:e,path:o,paths:n=[],...c}=t;"string"==typeof o?a(o,()=>N(r,o),e,{deep:!0,...c}):n.length>0?a(n.map(e=>[s,e].filter(Boolean).filter(e=>e.length>0).join(".")),n.map(e=>()=>N(r,e)),e,{deep:!0,...c}):a("state",()=>r.state,e,{deep:!0,...c})}return e},[])},ie=(e,t)=>{const s=je(e);for(const r of ce(e,t)){const e=s.watchers.find(e=>{const t=e.path===r.path,s=e.signature===r.signature;return t&&s});e&&e.unwatch(),s.watchers.push(r.start())}return s},pe=e=>{const{space:t,name:s}=Y(e);return void 0!==s?t in K.spaces&&"stores"in K.spaces[t]&&s in K.spaces[t].stores:t in K.spaces},ue=e=>{},fe=(e,t,...s)=>{const{store:r}=Oe(e);if(t in r.actions)try{return r.actions[t](...s)}catch(e){console.error(`Something went wrong with the action '${t}'`),console.error(e)}else console.warn(`Couldn't find the action '${t}' to run.`)},he=(e,t,...s)=>{const{store:r}=Oe(e);if(t in r.getters)try{return"function"==typeof r.getters[t]?r.getters[t](...s):r.getters[t]}catch(e){console.error(`Something went wrong with the getter '${t}'`),console.error(e)}else console.warn(`Couldn't find the getter '${t}' to resolve.`)},le=(e,t,s)=>{const{space:r,name:o}=Y(e),n=je({space:r,name:o});return C(n,t,s)},de=(e,t,s)=>{const r=je(e);return J(r,t,s)},ye=(e,t,s,r)=>{const{space:o,name:n}=Y(e),a=je({space:o,name:n});return N(a,t,s)||r},ge=(e,t,s,r)=>function(){return ye(e,t,s||this,r)},me=(e,t,s,r)=>{const o=je(e);F(o,t,s,r)},Pe=(e,t,s)=>function(r){me(e,t,r,s||this)},ve=(e,t,s,r)=>{const o=je(e);D(o,t,s,r)},Se=(e,t,s,r)=>{const o=je(e);I(o,t,s,r)},we=(e,t,s)=>{const r=(t,s)=>({get:ge(e,t,s),set:Pe(e,t,s)});return Array.isArray(t)?t.reduce((e,t)=>(e[t]=r(t,s),e),{}):u(t)?Object.keys(t).reduce((e,o)=>(e[o]=r(t[o],s),e),{}):r(t,s)},be=(e={})=>{"function"==typeof e.teddy&&e.teddy(K);for(const t of Object.keys(K.spaces||{})){"function"==typeof e.space&&e.space(t);for(const s of Object.keys(K.spaces[t].stores||{}))"function"==typeof e.store&&e.store(t,s)}},_e=(e=(e=>e))=>({setStore:e(Z),makeState:e(ee),setState:e(se),applyState:e(te),makeGetters:e(re),setGetters:e(oe),makeActions:e(ne),setActions:e(ae),makeWatchers:e(ce),setWatchers:e(ie),exists:e(pe),reset:e(ue),run:e(fe),resolve:e(he),remove:e(le),has:e(de),get:e(ye),getter:e(ge),set:e(me),setter:e(Pe),sync:e(we),push:e(ve),unshift:e(Se)}),ke=(e=Q)=>(e in K.spaces||(K.spaces[e]={}),K.spaces[e]),Ae=(e=Q)=>({store:ke(e),..._e(t=>(...s)=>t({space:e,name:X},...s))}),je=e=>{const{space:t=Q,name:s=X}=Y(e);return ke(t),"stores"in K.spaces[t]||(K.spaces[t].stores={}),s in K.spaces[t].stores||(K.spaces[t].stores[s]={getters:{},actions:{},watchers:[],options:{},features:{}},te(0,{},K.spaces[t].stores[s])),K.spaces[t].stores[s]},Oe=e=>({store:je(e),..._e(t=>(...s)=>t(e,...s))}),Ge=e=>{a(V,Oe(e))},$e=()=>{c(U)},Te=()=>{c(V)},We=e=>{if(u(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?i(e):Object.keys(e).reduce((t,s)=>(t[s]=i(e[s]),t),{})}return i(e)};var xe=Object.freeze({__proto__:null,accessors:R,features:j,Teddy:U,TeddyStore:V,Teddies:K,setStore:Z,makeState:ee,applyState:te,setState:se,makeGetters:re,setGetters:oe,makeActions:ne,setActions:ae,makeWatchers:ce,setWatchers:ie,exists:pe,reset:ue,run:fe,resolve:he,remove:le,has:de,get:ye,getter:ge,set:me,setter:Pe,push:ve,unshift:Se,sync:we,setFeature:be,mapMethods:_e,getTeddy:ke,useTeddy:Ae,getStore:je,useStore:Oe,provideTeddyStore:Ge,injectTeddy:$e,injectTeddyStore:Te,computed:We});const ze=e=>{e.prototype.$teddy=xe};export{K as Teddies,U as Teddy,V as TeddyStore,R as accessors,te as applyState,We as computed,pe as exists,j as features,ye as get,je as getStore,ke as getTeddy,ge as getter,de as has,$e as injectTeddy,Te as injectTeddyStore,ze as install,ne as makeActions,re as makeGetters,ee as makeState,ce as makeWatchers,_e as mapMethods,Ge as provideTeddyStore,ve as push,le as remove,ue as reset,he as resolve,fe as run,me as set,ae as setActions,be as setFeature,oe as setGetters,se as setState,Z as setStore,ie as setWatchers,Pe as setter,we as sync,Se as unshift,Oe as useStore,Ae as useTeddy};
