/*!
  * vue-teddy-store v0.5.2
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.5.2
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import e,{reactive as t,isRef as s,set as r,unref as n,ref as o,provide as a,inject as c,computed as i,watch as p}from"@vue/composition-api";import u from"debounce";import{isObject as f,makeSet as h,makeHas as l,makeGet as d,makeRemove as y,makePush as m,makeUnshift as g,makeInsert as v,isValidKey as P}from"object-string-path";import S from"vue";import _ from"fast-deep-equal";import b from"fn-annotate";import w from"object-hash";import A from"fast-safe-stringify";const j=(e,t)=>`teddy:${e}:${t}`;var k={store(e,t){const s=Fe({space:e,name:t});if(s.features.cache)return;const r=window.localStorage||global.localStorage||{};if(r){const n=r.getItem(j(e,t));n&&(s.state=JSON.parse(n)),ye({space:e,name:t},{handler(s){r.setItem(j(e,t),JSON.stringify(s))},immediate:!0,deep:!0}),s.features.cache=!0}}},O={store(e,s){const r=Fe({space:e,name:s});r.features.history||(r.features.history={},r.features.history.stack=t([]),ye({space:e,name:s},{handler(e){r.features.history.stack.push({state:e,ts:(new Date).getTime()})},immediate:!0,deep:!0}),r.features.history.installed=!0)}},G={store(e,t){const s=Fe({space:e,name:t});s.features.sync||(s.features.sync={},window&&window.addEventListener("storage",u(r=>{r.key===j(e,t)&&(s.state={...s.state,...JSON.parse(r.newValue)})},200)),s.features.sync.installed=!0)}},$=Object.freeze({__proto__:null,cache:k,history:O,sync:G});function T(e){if(!f(e)||f(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}const W=(e={})=>{const t=e.__ob__;return()=>{t&&t.dep.notify()}};function x(e,t,n){const o=s(e);return function(e){const t=parseFloat(String(e));return t>=0&&Math.floor(t)===t&&isFinite(e)}(t)||P(t)?o?(r(e.value,t,n),e.value[t]):(r(e,t,n),e[t]):o?(e.value=n,e.value):e=n}function z(e,t){if(f(e)||Array.isArray(e))return P(t)?s(e)?e.value[t]:e[t]:s(e)?e.value:e}function F(e,t){return!(!f(e)&&!Array.isArray(e))&&(!!P(t)&&(!!(T(e)&&e.value&&t in e.value)||(!(!e||!(t in e))||void 0)))}function I(e,t){const r=n(e),o=s(e),a=W(e);if(Array.isArray(r))return o?(e.value.push(t),a(),e.value.slice(-1)[0]):(e.push(t),a(),e.slice(-1)[0])}function J(e,t){const r=n(e),o=s(e);if(Array.isArray(r))return o?(e.value.unshift(t),e.value):(e.unshift(t),e)}function N(e,t,r){const o=n(e),a=s(e),c=W(e);if(Array.isArray(o))return a?(e.value.splice(t,0,r),c(),e.value):(e.splice(t,0,r),c(),e)}function C(e=[]){return"_state"!==e[0]?["_state",...e]:e}const D=h({setProp:x,getProp:z,hasProp:F,afterGetSteps:C}),M=l({getProp:z,hasProp:F,afterGetSteps:C}),q=d({getProp:z,hasProp:F,afterGetSteps:C}),B=y({getProp:z,hasProp:F,removeProp:function(e,t){const r=n(e),o=s(e),a=W(e);return Array.isArray(r)?(o?e.value.splice(+t,1):e.splice(+t,1),a(),!0):!!f(r)&&(o?e.value=function(e,t=[]){return Object.keys(e).reduce((s,r)=>(t.includes(r)||(s[r]=e[r]),s),{})}(e.value,[t]):delete e[t],a(),!0)},afterGetSteps:C}),E=m({getProp:z,hasProp:F,pushProp:I,afterGetSteps:C}),H=g({getProp:z,hasProp:F,unshiftProp:J,afterGetSteps:C}),L=v({getProp:z,hasProp:F,insertProp:N,afterGetSteps:C}),R=h({setProp:x,getProp:z,hasProp:F}),U=l({getProp:z,hasProp:F}),V=d({getProp:z,hasProp:F}),K=y({getProp:z,hasProp:F}),Q=m({getProp:z,hasProp:F,pushProp:I}),X=g({getProp:z,hasProp:F,unshiftProp:J}),Y=v({getProp:z,hasProp:F,insertProp:N});var Z=Object.freeze({__proto__:null,teddySet:D,teddyHas:M,teddyGet:q,teddyRemove:B,teddyPush:E,teddyUnshift:H,teddyInsert:L,set:R,has:U,get:V,remove:K,push:Q,unshift:X,insert:Y});S.use(e);const ee=Symbol(),te=Symbol(),se={__options:{devtools:!0},spaces:{}},re="$",ne="@",oe=e=>{let t,s;if(f(e))t="space"in e?e.space:re,s="name"in e?e.name:ne;else if("string"==typeof e)if(e.includes(".")){let[r,n]=e.split(".");t=r,s=n}else if(e.includes("/")){let[r,n]=e.split("/");t=r,s=n}else t=re,s=e;return"string"==typeof t&&(t=t.trim(),0===t.length&&(t=void 0)),"string"==typeof s&&(s=s.trim(),0===s.length&&(s=void 0)),{space:t,name:s}},ae=(e,t)=>{const s=oe(e);t=t||{};const r=Fe(s);return pe(s,t.state),fe(s,t.getters),le(s,t.actions),ye(s,t.watchers),r},ce=(e,t)=>s(t)?t:o(t),ie=(e,t,s={})=>(s._state=ce(0,t),"state"in s||Object.defineProperty(s,"state",{get:()=>s._state.value,set:e=>{s._state.value=e},enumerable:!0}),s),pe=(e,t)=>{const s=Fe(e);ie(0,t,s)},ue=(e,t)=>{const s=Fe(e);return t=t||{},Object.keys(t).reduce((e,r)=>(T(t[r])?e[r]=t[r]:"function"==typeof t[r]&&(b(t[r]).length>1?e[r]=function(...e){const n=w(A(e)),o=`__${r}_${n}`;return o in this||(this[o]=De(()=>t[r](s,...e))),this[o]}:e[r]=De(()=>t[r](s))),e),{})},fe=(e,t)=>{const s=Fe(e);return s.getters={...s.getters||{},...ue(e,t)},s},he=(e,t)=>{const s=Fe(e);return t=t||{},Object.keys(t).reduce((e,r)=>("function"==typeof t[r]&&(e[r]=(...e)=>t[r](s,...e)),e),{})},le=(e,t)=>{const s=Fe(e);return s.actions={...s.actions||{},...he(e,t)},s},de=(e,t)=>{const{name:s}=oe(e),r=Fe(e),n=[];return Array.isArray(t)?n.push(...t):t&&n.push(t),0===n.length?[]:n.reduce((e,t)=>{const n=(e,t=null)=>{const s=function(t,s){e.call(this,t,s,_(t,s))};return"number"==typeof t?u(s,t,!0):s},o=(e="",t)=>`${e}||${t.toString()}`,a=(t,s,r,a={})=>{e.push({path:t,signature:o(t,r),options:a,start(){return this.unwatch=p(s,n(r,a.debounce),{deep:!0,...a}),this}})};if("function"==typeof t)a("state",()=>r.state,t,{deep:!0});else if(t&&"object"==typeof t&&"handler"in t){const{handler:e,path:n,paths:o=[],...c}=t;"string"==typeof n?a(n,()=>q(r,n),e,{deep:!0,...c}):o.length>0?a(o.map(e=>[s,e].filter(Boolean).filter(e=>e.length>0).join(".")),o.map(e=>()=>q(r,e)),e,{deep:!0,...c}):a("state",()=>r.state,e,{deep:!0,...c})}return e},[])},ye=(e,t)=>{const s=Fe(e);for(const r of de(e,t)){const e=s.watchers.find(e=>{const t=e.path===r.path,s=e.signature===r.signature;return t&&s});e&&e.unwatch(),s.watchers.push(r.start())}return s},me=e=>{const{space:t,name:s}=oe(e);return void 0!==s?t in se.spaces&&"stores"in se.spaces[t]&&s in se.spaces[t].stores:t in se.spaces},ge=e=>{},ve=(e,t,...s)=>{const{store:r}=Ie(e);if(t in r.actions)try{return r.actions[t](...s)}catch(e){console.error(`Something went wrong with the action '${t}'`),console.error(e)}else console.warn(`Couldn't find the action '${t}' to run.`)},Pe=(e,t,...s)=>{const{store:r}=Ie(e);if(t in r.getters)try{return"function"==typeof r.getters[t]?r.getters[t](...s):r.getters[t]}catch(e){console.error(`Something went wrong with the getter '${t}'`),console.error(e)}else console.warn(`Couldn't find the getter '${t}' to resolve.`)},Se=(e,t,s)=>{const{space:r,name:n}=oe(e),o=Fe({space:r,name:n});return B(o,t,s)},_e=(e,t,s)=>{const r=Fe(e);return M(r,t,s)},be=(e,t,s,r)=>{const{space:n,name:o}=oe(e),a=Fe({space:n,name:o});return q(a,t,s)||r},we=(e,t,s,r)=>function(){return be(e,t,s||this,r)},Ae=(e,t,s,r)=>{const n=Fe(e);D(n,t,s,r)},je=(e,t,s)=>function(r){Ae(e,t,r,s||this)},ke=(e,t,s,r)=>{const n=Fe(e);E(n,t,s,r)},Oe=(e,t,s,r)=>{const n=Fe(e);L(n,t,s,r)},Ge=(e,t,s,r)=>{const n=Fe(e);H(n,t,s,r)},$e=(e,t,s)=>{const r=(t,s)=>({get:we(e,t,s),set:je(e,t,s)});return Array.isArray(t)?t.reduce((e,t)=>(e[t]=r(t,s),e),{}):f(t)?Object.keys(t).reduce((e,n)=>(e[n]=r(t[n],s),e),{}):r(t,s)},Te=(e={},{spaces:t={"*":"*"}}={})=>{"function"==typeof e.teddy&&e.teddy(se);const s="*"in t?Object.keys(se.spaces||{}):Object.keys(t);for(const r of s)if("function"==typeof e.space&&e.space(r),r in se.spaces){const s=Object.keys(se.spaces[r].stores||{}),n="*"in t&&"*"===t["*"]?s:t[r];if(Array.isArray(n))for(const t of n)"function"==typeof e.store&&e.store(r,t)}},We=(e=(e=>e))=>({setStore:e(ae),makeState:e(ce),setState:e(pe),applyState:e(ie),makeGetters:e(ue),setGetters:e(fe),makeActions:e(he),setActions:e(le),makeWatchers:e(de),setWatchers:e(ye),exists:e(me),reset:e(ge),run:e(ve),resolve:e(Pe),remove:e(Se),has:e(_e),get:e(be),getter:e(we),set:e(Ae),setter:e(je),sync:e($e),push:e(ke),unshift:e(Ge),insert:e(Oe)}),xe=(e=re)=>(e in se.spaces||(se.spaces[e]={}),se.spaces[e]),ze=(e=re)=>({store:xe(e),...We(t=>(...s)=>t({space:e,name:ne},...s))}),Fe=e=>{const{space:t=re,name:s=ne}=oe(e);return xe(t),"stores"in se.spaces[t]||(se.spaces[t].stores={}),s in se.spaces[t].stores||(se.spaces[t].stores[s]={getters:{},actions:{},watchers:[],options:{},features:{}},ie(0,{},se.spaces[t].stores[s])),se.spaces[t].stores[s]},Ie=e=>({store:Fe(e),...We(t=>(...s)=>t(e,...s))}),Je=e=>{a(te,Ie(e))},Ne=()=>{c(ee)},Ce=()=>{c(te)},De=e=>{if(f(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?i(e):Object.keys(e).reduce((t,s)=>(t[s]=i(e[s]),t),{})}return i(e)};var Me=Object.freeze({__proto__:null,accessors:Z,features:$,Teddy:ee,TeddyStore:te,Teddies:se,setStore:ae,makeState:ce,applyState:ie,setState:pe,makeGetters:ue,setGetters:fe,makeActions:he,setActions:le,makeWatchers:de,setWatchers:ye,exists:me,reset:ge,run:ve,resolve:Pe,remove:Se,has:_e,get:be,getter:we,set:Ae,setter:je,push:ke,insert:Oe,unshift:Ge,sync:$e,setFeature:Te,mapMethods:We,getTeddy:xe,useTeddy:ze,getStore:Fe,useStore:Ie,provideTeddyStore:Je,injectTeddy:Ne,injectTeddyStore:Ce,computed:De});const qe=e=>{e.prototype.$teddy=Me};export{se as Teddies,ee as Teddy,te as TeddyStore,Z as accessors,ie as applyState,De as computed,me as exists,$ as features,be as get,Fe as getStore,xe as getTeddy,we as getter,_e as has,Ne as injectTeddy,Ce as injectTeddyStore,Oe as insert,qe as install,he as makeActions,ue as makeGetters,ce as makeState,de as makeWatchers,We as mapMethods,Je as provideTeddyStore,ke as push,Se as remove,ge as reset,Pe as resolve,ve as run,Ae as set,le as setActions,Te as setFeature,fe as setGetters,pe as setState,ae as setStore,ye as setWatchers,je as setter,$e as sync,Ge as unshift,Ie as useStore,ze as useTeddy};
