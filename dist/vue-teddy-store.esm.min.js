/*!
  * vue-teddy-store v0.1.31
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.1.31
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import{isObject as t,makeGet as e,isValidKey as s,makeSet as r,makeHas as o}from"object-string-path";import{watch as n,reactive as i,isRef as a,ref as c,computed as u}from"@vue/composition-api";import h from"vue";function d(e){if(!t(e)||t(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}function l(t){return t.filter(Boolean).filter(t=>t.length>0).join(".")}function p(e,r,o){return s(r)&&(t(e)||Array.isArray(e))?d(e)&&"value"in e&&r in e.value?(e.value[r]=o,e.value[r]):(e[r]=o,e[r]):e&&null==r?(d(e)&&"value"in e?e.value=o:t(o)?Object.assign(e,o):e=o,e):void console.log("Couldn't not set "+r)}function f(e,r){return s(r)?d(e)?r in e.value?e.value[r]:e.value:t(e)||Array.isArray(e)?e[r]:void 0:e&&void 0===r?d(e)?e.value:e:void 0}function _(e,r){return!(!t(e)&&!Array.isArray(e))&&(!!s(r)&&(!!(d(e)&&e.value&&r in e.value)||(!(!e||!(r in e))||void 0)))}function g(t){return e=>{const[s,...r]=e||[];return s?(t(s),["_stores",s,"state",...r]):[]}}const y=(t=(t=>t))=>r({setProp:p,getProp:f,hasProp:_,afterGetSteps:g(t)}),v=(t=(t=>t))=>o({getProp:f,hasProp:_,afterGetSteps:g(t)}),m=(t=(t=>t))=>e({getProp:f,hasProp:_,afterGetSteps:g(t)}),O=r({setProp:p,getProp:f,hasProp:_}),b=o({getProp:f,hasProp:_}),P=e({getProp:f,hasProp:_});var w=Object.freeze({__proto__:null,makeTeddySet:y,makeTeddyHas:v,makeTeddyGet:m,set:O,has:b,get:P});const S=t=>"teddy:store:"+t;var j={handle({name:t,store:e}){const s=window.localStorage||global.localStorage||{};if(s){const r=s.getItem(S(t));r&&(e.state={...e.state,...JSON.parse(r)}),n(()=>e.state,(e,r)=>{e!==r&&s.setItem(S(t),JSON.stringify(e))},{immediate:!0,deep:!0})}}},A={handle({store:t}){t._history=i([]),n(t.state,e=>{t._history.push(e)},{immediate:!0,deep:!0})}},$={handle({name:t,store:e}){window&&window.addEventListener("storage",s=>{s.key===S(t)&&(e.state={...e.state,...JSON.parse(s.newValue)})})}},x=Object.freeze({__proto__:null,cache:j,history:A,sync:$});const k=("undefined"!=typeof window?window:"undefined"!=typeof global?global:{__VUE_DEVTOOLS_GLOBAL_HOOK__:void 0}).__VUE_DEVTOOLS_GLOBAL_HOOK__,G=[];let E;class T extends Error{constructor(t){super(t),this.name="MissingStoreError"}}class L{constructor(t){this._options={devtools:h.config.devtools,...t||{}},this._vueInstance=null,this._stores={},this._features=x,this.add("@",{state:{}})}add(t,e){return e=e||{},this._stores[t]={},this[t]=this._stores[t],this.addState(t,e.state),this.addGetters(t,e.getters),this.addActions(t,e.actions),this.addStoreProperties(t,function(t,e=[]){return Object.keys(t).reduce((s,r)=>(e.includes(r)||(s[r]=t[r]),s),{})}(e,["state","getters","actions","watcher","watchers","devtools"])),this.registerWatchers(t,e.watcher),this.registerWatchers(t,e.watchers),(e.devtools||this._options.devtools)&&this.registerForDevtools(t),this}addStoreProperties(t,e,s){const{allowOverriding:r=!1,alsoAtPath:o=null}=s||{};this._stores[t]||(this._stores[t]={});for(const s of Object.keys(e||{}))!(s in this._stores[t])||r?(this._stores[t][s]=e[s],"string"==typeof o&&(this._stores[t][o]||(this._stores[t][o]={}),this._stores[t][o][s]=this._stores[t][s])):console.warn(`addStoreProperties('${t}',...) - Couldn't override property ${s} on store '${t}'`);return this}addState(t,e){this._stores[t]||(this._stores[t]={});const s=I(e);return this._stores[t]._state=s,Object.defineProperty(this._stores[t],"state",{get:()=>s.value,set:t=>{s.value=t},enumerable:!0}),this}addGetters(t,e){return this.addStoreProperties(t,W(e),{alsoAtPath:"_getters"}),this}addActions(t,e){return this.addStoreProperties(t,D(this._stores[t],e),{alsoAtPath:"_actions"}),this}registerWatchers(t,e){const s=[];if(Array.isArray(e)?s.push(...e):e&&s.push(e),this.exists(t)&&0!==s.length){for(let e of s)if("function"==typeof e)n(()=>this._stores[t].state,e,{deep:!0});else if(e&&"object"==typeof e&&"handler"in e){const{handler:s,path:r,paths:o=[],...i}=e;"string"==typeof r?n(()=>m()(this,l([t,r])),s,{deep:!0,...i}):o.length>0?n(o.map(e=>()=>m()(this,l([t,e]))),s,{deep:!0,...i}):n(()=>this._stores[t].state,s,{deep:!0,...i})}return this}}registerForDevtools(t){return function(t,e){if(!k)return;Object.defineProperty(e,"getters",{get:()=>e._getters});const s={...e,_devtoolHook:k,_vm:{$options:{computed:{}}},_mutations:{},replaceState:()=>{}};k.emit("vuex:init",s),k.on("vuex:travel-to-state",t=>{Object.assign(e.state,t)}),function s(r,o=""){for(const n in r){const i=`${o}${o?".":""}${n}`;if(G.includes(i))continue;G.push(i);const a=t=>{"object"==typeof t&&s(t,i)};e.registerWatchers(t,{path:i,handler(t){a(t),k.emit("vuex:mutation",{type:"change",payload:{key:i,value:t}},e.state)}}),a(r[n])}}(e.state)}(t,this._stores[t])}exists(t){return t in this._stores}remove(t){t in this&&delete this[t],t in this._stores&&delete this._stores[t]}reset(){for(let t in this._stores)this.remove(t)}use(t={}){return"function"==typeof t.install&&t.install(this),"function"==typeof t.handle&&Object.keys(this._stores).map(e=>t.handle.call(this,{name:e,store:this._stores[e]})),this}activate(t=[]){Array.isArray(t)||(t=[t]);for(let e of t)e in this._features&&this.use(this._features[e]);return this}attachTo(t){return this._vueInstance=t,this}install(...t){const e=this,[s]=t;if(s.version.startsWith("2")){if(E&&s===E)return;E=s,Object.defineProperty(s.prototype,"$teddy",{get(){return e.attachTo(this)},enumerable:!0,configurable:!0})}else if(s.version.startsWith("3")){const[s]=t;s.provide("$teddy"),Object.defineProperty(s.config.globalProperties,"$teddy",{get(){return e.attachTo(this)},configurable:!0})}}get stores(){return this._stores}has(t,e){return V(t,e)}get(t,e){return B(t,e)}getter(t,e){return M(t,e)}set(t,e,s){return H(t,e,s)}setter(t,e){return z(t,e)}sync(t,e){return C(t,e)}computed(t){return J(t)}}const I=(t={})=>a(t)?t:c(t),W=t=>(t=t||{},Object.keys(t).reduce((e,s)=>(d(t[s])?e[s]=t[s]:"function"==typeof t[s]&&(e[s]=J(t[s])),e),{})),D=(t,e)=>(e=e||{},Object.keys(e).reduce((s,r)=>{if("function"==typeof e[r]){const o={state:t.state,getter:t.getters};s[r]=(...t)=>e[r](o,...t)}return s},{})),V=(t,e)=>{const s=E.prototype.$teddy;return v(e=>{if(!s.exists(e))throw new T(`You're trying to use the method .has('${t}', context?) on a store which doesn't exists: '${e}'`)})(s,t,N(e,s))},B=(t,e)=>{const s=E.prototype.$teddy;return m(e=>{if(!s.exists(e))throw new T(`You're trying to use the method .get('${t}', context?) on a store which doesn't exists: '${e}'`)})(s,t,N(e,s))},H=(t,e,s)=>{const r=E.prototype.$teddy;y(e=>{if(!r.exists(e))throw new T(`You're trying to use the method .set('${t}', value, context?) on a store which doesn't exists: '${e}'`)})(r,t,e,N(s,r))},M=(t,e)=>function(){return B(t,e)},z=(t,e)=>function(s){H(t,s,e)},C=(e,s)=>{const r=(t,e)=>({get:M(t,e),set:z(t,e)});return Array.isArray(e)?e.reduce((t,e)=>(t[e]=r(e,s),t),{}):t(e)?Object.keys(e).reduce((t,o)=>(t[o]=r(e[o],s),t),{}):r(e,s)},J=e=>{if(t(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?u(e):Object.keys(e).reduce((t,s)=>(t[s]=u(e[s]),t),{})}return u(e)};function N(...e){return e.filter(Boolean).reduce((e,s)=>s instanceof L&&s._vueInstance?s._vueInstance:t(s)?s:e,{})}var Y=Object.freeze({__proto__:null,MissingStoreError:T,default:L,createState:I,createGetters:W,createActions:D,has:V,get:B,set:H,getter:M,setter:z,sync:C,computed:J,resolveContext:N});const{has:F,get:K,set:U,sync:q,computed:Q,setter:R,getter:X,createGetters:Z,createState:tt,MissingStoreError:et}=Y;export default L;export{et as MissingStoreError,w as accessors,Q as computed,Z as createGetters,tt as createState,K as get,X as getter,F as has,U as set,R as setter,q as sync};
