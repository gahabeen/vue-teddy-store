/*!
  * vue-teddy-store v0.4.1
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.4.1
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import e,{reactive as t,isRef as s,set as r,unref as n,ref as o,provide as a,inject as c,computed as i,watch as p}from"@vue/composition-api";import{isObject as u,makeSet as f,makeHas as l,makeGet as h,makeRemove as d,makePush as y,makeUnshift as g,makeInsert as m,isValidKey as v}from"object-string-path";import P from"vue";import S from"debounce";import w from"fast-deep-equal";import _ from"fn-annotate";const b=(e,t)=>`teddy:${e}:${t}`;var A={store(e,t){const s=xe({space:e,name:t});if(s.features.cache)return;const r=window.localStorage||global.localStorage||{};if(r){const n=r.getItem(b(e,t));n&&(s.state=JSON.parse(n)),he({space:e,name:t},{handler(s){r.setItem(b(e,t),JSON.stringify(s))},immediate:!0,deep:!0}),s.features.cache=!0}}},k={store(e,s){const r=xe({space:e,name:s});r.features.history||(r.features.history={},r.features.history.stack=t([]),he({space:e,name:s},{handler(e){r.features.history.stack.push({state:e,ts:(new Date).getTime()})},immediate:!0,deep:!0}),r.features.history.installed=!0)}},j={store(e,t){const s=xe({space:e,name:t});s.features.sync||(s.features.sync={},window&&window.addEventListener("storage",r=>{r.key===b(e,t)&&(s.state={...s.state,...JSON.parse(r.newValue)})}),s.features.sync.installed=!0)}},O=Object.freeze({__proto__:null,cache:A,history:k,sync:j});function G(e){if(!u(e)||u(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}const $=(e={})=>{const t=e.__ob__;return()=>{t&&t.dep.notify()}};function T(e,t,n){const o=s(e);return function(e){const t=parseFloat(String(e));return t>=0&&Math.floor(t)===t&&isFinite(e)}(t)||v(t)?o?(r(e.value,t,n),e.value[t]):(r(e,t,n),e[t]):o?(e.value=n,e.value):e=n}function W(e,t){if(u(e)||Array.isArray(e))return v(t)?s(e)?e.value[t]:e[t]:s(e)?e.value:e}function x(e,t){return!(!u(e)&&!Array.isArray(e))&&(!!v(t)&&(!!(G(e)&&e.value&&t in e.value)||(!(!e||!(t in e))||void 0)))}function z(e,t){const r=n(e),o=s(e),a=$(e);if(Array.isArray(r))return o?(e.value.push(t),a(),e.value.slice(-1)[0]):(e.push(t),a(),e.slice(-1)[0])}function F(e,t){const r=n(e),o=s(e);if(Array.isArray(r))return o?(e.value.unshift(t),e.value):(e.unshift(t),e)}function I(e,t,r){const o=n(e),a=s(e),c=$(e);if(Array.isArray(o))return a?(e.value.splice(t,0,r),c(),e.value):(e.splice(t,0,r),c(),e)}function J(e=[]){return"_state"!==e[0]?["_state",...e]:e}const N=f({setProp:T,getProp:W,hasProp:x,afterGetSteps:J}),C=l({getProp:W,hasProp:x,afterGetSteps:J}),D=h({getProp:W,hasProp:x,afterGetSteps:J}),M=d({getProp:W,hasProp:x,removeProp:function(e,t){const r=n(e),o=s(e),a=$(e);return Array.isArray(r)?(o?e.value.splice(+t,1):e.splice(+t,1),a(),!0):!!u(r)&&(o?e.value=function(e,t=[]){return Object.keys(e).reduce((s,r)=>(t.includes(r)||(s[r]=e[r]),s),{})}(e.value,[t]):delete e[t],a(),!0)},afterGetSteps:J}),q=y({getProp:W,hasProp:x,pushProp:z,afterGetSteps:J}),B=g({getProp:W,hasProp:x,unshiftProp:F,afterGetSteps:J}),E=m({getProp:W,hasProp:x,insertProp:I,afterGetSteps:J}),H=f({setProp:T,getProp:W,hasProp:x}),L=l({getProp:W,hasProp:x}),R=h({getProp:W,hasProp:x}),U=d({getProp:W,hasProp:x}),V=y({getProp:W,hasProp:x,pushProp:z}),K=g({getProp:W,hasProp:x,unshiftProp:F}),Q=m({getProp:W,hasProp:x,insertProp:I});var X=Object.freeze({__proto__:null,teddySet:N,teddyHas:C,teddyGet:D,teddyRemove:M,teddyPush:q,teddyUnshift:B,teddyInsert:E,set:H,has:L,get:R,remove:U,push:V,unshift:K,insert:Q});P.use(e);const Y=Symbol(),Z=Symbol(),ee={__options:{devtools:!0},spaces:{}},te="$",se="@",re=e=>{let t,s;if(u(e))t="space"in e?e.space:te,s="name"in e?e.name:se;else if("string"==typeof e)if(e.includes(".")){let[r,n]=e.split(".");t=r,s=n}else if(e.includes("/")){let[r,n]=e.split("/");t=r,s=n}else t=te,s=e;return"string"==typeof t&&(t=t.trim(),0===t.length&&(t=void 0)),"string"==typeof s&&(s=s.trim(),0===s.length&&(s=void 0)),{space:t,name:s}},ne=(e,t)=>{const s=re(e);t=t||{};const r=xe(s);return ce(s,t.state),pe(s,t.getters),fe(s,t.actions),he(s,t.watchers),r},oe=(e,t)=>s(t)?t:o(t),ae=(e,t,s={})=>(s._state=oe(0,t),"state"in s||Object.defineProperty(s,"state",{get:()=>s._state.value,set:e=>{s._state.value=e},enumerable:!0}),s),ce=(e,t)=>{const s=xe(e);ae(0,t,s)},ie=(e,t)=>{const s=xe(e);return t=t||{},Object.keys(t).reduce((e,r)=>(G(t[r])?e[r]=t[r]:"function"==typeof t[r]&&(_(t[r]).length>1?e[r]=(...e)=>Ne(()=>t[r](s,...e)):e[r]=Ne(()=>t[r](s))),e),{})},pe=(e,t)=>{const s=xe(e);return s.getters={...s.getters||{},...ie(e,t)},s},ue=(e,t)=>{const s=xe(e);return t=t||{},Object.keys(t).reduce((e,r)=>("function"==typeof t[r]&&(e[r]=(...e)=>t[r](s,...e)),e),{})},fe=(e,t)=>{const s=xe(e);return s.actions={...s.actions||{},...ue(e,t)},s},le=(e,t)=>{const{name:s}=re(e),r=xe(e),n=[];return Array.isArray(t)?n.push(...t):t&&n.push(t),0===n.length?[]:n.reduce((e,t)=>{const n=(e,t=null)=>{const s=function(t,s){e.call(this,t,s,w(t,s))};return"number"==typeof t?S(s,t,!0):s},o=(e="",t)=>`${e}||${t.toString()}`,a=(t,s,r,a={})=>{e.push({path:t,signature:o(t,r),options:a,start(){return this.unwatch=p(s,n(r,a.debounce),{deep:!0,...a}),this}})};if("function"==typeof t)a("state",()=>r.state,t,{deep:!0});else if(t&&"object"==typeof t&&"handler"in t){const{handler:e,path:n,paths:o=[],...c}=t;"string"==typeof n?a(n,()=>D(r,n),e,{deep:!0,...c}):o.length>0?a(o.map(e=>[s,e].filter(Boolean).filter(e=>e.length>0).join(".")),o.map(e=>()=>D(r,e)),e,{deep:!0,...c}):a("state",()=>r.state,e,{deep:!0,...c})}return e},[])},he=(e,t)=>{const s=xe(e);for(const r of le(e,t)){const e=s.watchers.find(e=>{const t=e.path===r.path,s=e.signature===r.signature;return t&&s});e&&e.unwatch(),s.watchers.push(r.start())}return s},de=e=>{const{space:t,name:s}=re(e);return void 0!==s?t in ee.spaces&&"stores"in ee.spaces[t]&&s in ee.spaces[t].stores:t in ee.spaces},ye=e=>{},ge=(e,t,...s)=>{const{store:r}=ze(e);if(t in r.actions)try{return r.actions[t](...s)}catch(e){console.error(`Something went wrong with the action '${t}'`),console.error(e)}else console.warn(`Couldn't find the action '${t}' to run.`)},me=(e,t,...s)=>{const{store:r}=ze(e);if(t in r.getters)try{return"function"==typeof r.getters[t]?r.getters[t](...s):r.getters[t]}catch(e){console.error(`Something went wrong with the getter '${t}'`),console.error(e)}else console.warn(`Couldn't find the getter '${t}' to resolve.`)},ve=(e,t,s)=>{const{space:r,name:n}=re(e),o=xe({space:r,name:n});return M(o,t,s)},Pe=(e,t,s)=>{const r=xe(e);return C(r,t,s)},Se=(e,t,s,r)=>{const{space:n,name:o}=re(e),a=xe({space:n,name:o});return D(a,t,s)||r},we=(e,t,s,r)=>function(){return Se(e,t,s||this,r)},_e=(e,t,s,r)=>{const n=xe(e);N(n,t,s,r)},be=(e,t,s)=>function(r){_e(e,t,r,s||this)},Ae=(e,t,s,r)=>{const n=xe(e);q(n,t,s,r)},ke=(e,t,s,r)=>{const n=xe(e);E(n,t,s,r)},je=(e,t,s,r)=>{const n=xe(e);B(n,t,s,r)},Oe=(e,t,s)=>{const r=(t,s)=>({get:we(e,t,s),set:be(e,t,s)});return Array.isArray(t)?t.reduce((e,t)=>(e[t]=r(t,s),e),{}):u(t)?Object.keys(t).reduce((e,n)=>(e[n]=r(t[n],s),e),{}):r(t,s)},Ge=(e={})=>{"function"==typeof e.teddy&&e.teddy(ee);for(const t of Object.keys(ee.spaces||{})){"function"==typeof e.space&&e.space(t);for(const s of Object.keys(ee.spaces[t].stores||{}))"function"==typeof e.store&&e.store(t,s)}},$e=(e=(e=>e))=>({setStore:e(ne),makeState:e(oe),setState:e(ce),applyState:e(ae),makeGetters:e(ie),setGetters:e(pe),makeActions:e(ue),setActions:e(fe),makeWatchers:e(le),setWatchers:e(he),exists:e(de),reset:e(ye),run:e(ge),resolve:e(me),remove:e(ve),has:e(Pe),get:e(Se),getter:e(we),set:e(_e),setter:e(be),sync:e(Oe),push:e(Ae),unshift:e(je),insert:e(ke)}),Te=(e=te)=>(e in ee.spaces||(ee.spaces[e]={}),ee.spaces[e]),We=(e=te)=>({store:Te(e),...$e(t=>(...s)=>t({space:e,name:se},...s))}),xe=e=>{const{space:t=te,name:s=se}=re(e);return Te(t),"stores"in ee.spaces[t]||(ee.spaces[t].stores={}),s in ee.spaces[t].stores||(ee.spaces[t].stores[s]={getters:{},actions:{},watchers:[],options:{},features:{}},ae(0,{},ee.spaces[t].stores[s])),ee.spaces[t].stores[s]},ze=e=>({store:xe(e),...$e(t=>(...s)=>t(e,...s))}),Fe=e=>{a(Z,ze(e))},Ie=()=>{c(Y)},Je=()=>{c(Z)},Ne=e=>{if(u(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?i(e):Object.keys(e).reduce((t,s)=>(t[s]=i(e[s]),t),{})}return i(e)};var Ce=Object.freeze({__proto__:null,accessors:X,features:O,Teddy:Y,TeddyStore:Z,Teddies:ee,setStore:ne,makeState:oe,applyState:ae,setState:ce,makeGetters:ie,setGetters:pe,makeActions:ue,setActions:fe,makeWatchers:le,setWatchers:he,exists:de,reset:ye,run:ge,resolve:me,remove:ve,has:Pe,get:Se,getter:we,set:_e,setter:be,push:Ae,insert:ke,unshift:je,sync:Oe,setFeature:Ge,mapMethods:$e,getTeddy:Te,useTeddy:We,getStore:xe,useStore:ze,provideTeddyStore:Fe,injectTeddy:Ie,injectTeddyStore:Je,computed:Ne});const De=e=>{e.prototype.$teddy=Ce};export{ee as Teddies,Y as Teddy,Z as TeddyStore,X as accessors,ae as applyState,Ne as computed,de as exists,O as features,Se as get,xe as getStore,Te as getTeddy,we as getter,Pe as has,Ie as injectTeddy,Je as injectTeddyStore,ke as insert,De as install,ue as makeActions,ie as makeGetters,oe as makeState,le as makeWatchers,$e as mapMethods,Fe as provideTeddyStore,Ae as push,ve as remove,ye as reset,me as resolve,ge as run,_e as set,fe as setActions,Ge as setFeature,pe as setGetters,ce as setState,ne as setStore,he as setWatchers,be as setter,Oe as sync,je as unshift,ze as useStore,We as useTeddy};
