/*!
  * vue-teddy-store v0.2.9
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.2.9
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import e,{reactive as t,isRef as s,set as r,unref as n,ref as o,provide as a,inject as c,computed as i,watch as p}from"@vue/composition-api";import{isObject as u,makeSet as f,makeHas as d,makeGet as h,makeRemove as l,makePush as y,makeUnshift as m,isValidKey as g}from"object-string-path";import P from"vue";import v from"debounce";import S from"fast-deep-equal";const b=(e,t)=>`teddy:${e}:${t}`;var w={store(e,t){const s=ke({space:e,name:t});if(s.features.cache)return;const r=window.localStorage||global.localStorage||{};if(r){const n=r.getItem(b(e,t));n&&(s.state=JSON.parse(n)),ce({space:e,name:t},{handler(s){r.setItem(b(e,t),JSON.stringify(s))},immediate:!0,deep:!0}),s.features.cache=!0}}},_={store(e,s){const r=ke({space:e,name:s});r.features.history||(r.features.history={},r.features.history.stack=t([]),ce({space:e,name:s},{handler(e){r.features.history.stack.push({state:e,ts:(new Date).getTime()})},immediate:!0,deep:!0}),r.features.history.installed=!0)}},k={store(e,t){const s=ke({space:e,name:t});s.features.sync||(s.features.sync={},window&&window.addEventListener("storage",r=>{r.key===b(e,t)&&(s.state={...s.state,...JSON.parse(r.newValue)})}),s.features.sync.installed=!0)}},A=Object.freeze({__proto__:null,cache:w,history:_,sync:k});function j(e){if(!u(e)||u(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}function O(e,t,n){const o=s(e);(function(e){const t=parseFloat(String(e));return t>=0&&Math.floor(t)===t&&isFinite(e)})(t)||g(t)?r(o?e.value:e,t,n):o?e.value=n:e=n}function G(e,t){if(u(e)||Array.isArray(e))return g(t)?s(e)?e.value[t]:e[t]:s(e)?e.value:e}function T(e,t){return!(!u(e)&&!Array.isArray(e))&&(!!g(t)&&(!!(j(e)&&e.value&&t in e.value)||(!(!e||!(t in e))||void 0)))}function $(e,t){const r=n(e),o=s(e);if(Array.isArray(r))return o?[...e.value,t]:[...e,t]}function W(e,t){const r=n(e),o=s(e);if(Array.isArray(r))return o?(e.value.unshift(t),e.value):(e.unshift(t),e)}function x(e=[]){return"_state"!==e[0]?["_state",...e]:e}const z=f({setProp:O,getProp:G,hasProp:T,afterGetSteps:x}),F=d({getProp:G,hasProp:T,afterGetSteps:x}),J=h({getProp:G,hasProp:T,afterGetSteps:x}),N=l({getProp:G,hasProp:T,removeProp:function(e,t){const r=n(e),o=s(e);return Array.isArray(r)?(o?e.value.splice(+t,1):e.splice(+t,1),!0):!!u(r)&&(o?e.value=function(e,t=[]){return Object.keys(e).reduce((s,r)=>(t.includes(r)||(s[r]=e[r]),s),{})}(e.value,[t]):delete e[t],!0)},afterGetSteps:x}),D=y({setProp:O,getProp:G,hasProp:T,pushProp:$,afterGetSteps:x}),I=m({setProp:O,getProp:G,hasProp:T,unshiftProp:W,afterGetSteps:x}),M=f({setProp:O,getProp:G,hasProp:T}),q=d({getProp:G,hasProp:T}),B=h({getProp:G,hasProp:T}),C=l({getProp:G,hasProp:T}),E=y({setProp:O,getProp:G,hasProp:T,pushProp:$}),H=m({setProp:O,getProp:G,hasProp:T,unshiftProp:W});var L=Object.freeze({__proto__:null,teddySet:z,teddyHas:F,teddyGet:J,teddyRemove:N,teddyPush:D,teddyUnshift:I,set:M,has:q,get:B,remove:C,push:E,unshift:H});P.use(e);const R=Symbol(),U=Symbol(),V={__options:{devtools:!0},spaces:{}},K="$",Q="@",X=e=>{let t,s;if(u(e))t="space"in e?e.space:K,s="name"in e?e.name:Q;else if("string"==typeof e)if(e.includes(".")){let[r,n]=e.split(".");t=r,s=n}else if(e.includes("/")){let[r,n]=e.split("/");t=r,s=n}else t=K,s=e;return"string"==typeof t&&(t=t.trim(),0===t.length&&(t=void 0)),"string"==typeof s&&(s=s.trim(),0===s.length&&(s=void 0)),{space:t,name:s}},Y=(e,t)=>{const s=X(e);t=t||{};const r=ke(s);return te(s,t.state),re(s,t.getters),oe(s,t.actions),ce(s,t.watchers),r},Z=(e,t)=>s(t)?t:o(t),ee=(e,t,s={})=>(s._state=Z(0,t),"state"in s||Object.defineProperty(s,"state",{get:()=>s._state.value,set:e=>{s._state.value=e},enumerable:!0}),s),te=(e,t)=>{const s=ke(e);ee(0,t,s)},se=(e,t)=>{const s=ke(e);return t=t||{},Object.keys(t).reduce((e,r)=>(j(t[r])?e[r]=t[r]:"function"==typeof t[r]&&(e[r]=Te(()=>t[r](s))),e),{})},re=(e,t)=>{const s=ke(e);return s.getters={...s.getters||{},...se(e,t)},s},ne=(e,t)=>{const s=ke(e);return t=t||{},Object.keys(t).reduce((e,r)=>("function"==typeof t[r]&&(e[r]=(...e)=>t[r](s,...e)),e),{})},oe=(e,t)=>{const s=ke(e);return s.actions={...s.actions||{},...ne(e,t)},s},ae=(e,t)=>{const{name:s}=X(e),r=ke(e),n=[];return Array.isArray(t)?n.push(...t):t&&n.push(t),0===n.length?[]:n.reduce((e,t)=>{const n=(e,t=null)=>{const s=function(t,s){e.call(this,t,s,S(t,s))};return"number"==typeof t?v(s,t,!0):s},o=(e="",t)=>`${e}||${t.toString()}`,a=(t,s,r,a={})=>{e.push({path:t,signature:o(t,r),options:a,start(){return this.unwatch=p(s,n(r,a.debounce),{deep:!0,...a}),this}})};if("function"==typeof t)a("state",()=>r.state,t,{deep:!0});else if(t&&"object"==typeof t&&"handler"in t){const{handler:e,path:n,paths:o=[],...c}=t;"string"==typeof n?a(n,()=>J(r,n),e,{deep:!0,...c}):o.length>0?a(o.map(e=>[s,e].filter(Boolean).filter(e=>e.length>0).join(".")),o.map(e=>()=>J(r,e)),e,{deep:!0,...c}):a("state",()=>r.state,e,{deep:!0,...c})}return e},[])},ce=(e,t)=>{const s=ke(e);for(const r of ae(e,t)){const e=s.watchers.find(e=>{const t=e.path===r.path,s=e.signature===r.signature;return t&&s});e&&e.unwatch(),s.watchers.push(r.start())}return s},ie=e=>{const{space:t,name:s}=X(e);return void 0!==s?t in V.spaces&&"stores"in V.spaces[t]&&s in V.spaces[t].stores:t in V.spaces},pe=e=>{},ue=(e,t,...s)=>{const{store:r}=Ae(e);if(t in r.actions)try{return r.actions[t](...s)}catch(e){console.error(`Something went wrong with the action '${t}'`),console.error(e)}else console.warn(`Couldn't find the action '${t}' to run.`)},fe=(e,t,s)=>{const{space:r,name:n}=X(e),o=ke({space:r,name:n});return N(o,t,s)},de=(e,t,s)=>{const r=ke(e);return F(r,t,s)},he=(e,t,s,r)=>{const{space:n,name:o}=X(e),a=ke({space:n,name:o});return J(a,t,s)||r},le=(e,t,s,r)=>function(){return he(e,t,s||this,r)},ye=(e,t,s,r)=>{const n=ke(e);z(n,t,s,r)},me=(e,t,s)=>function(r){ye(e,t,r,s||this)},ge=(e,t,s,r)=>{const n=ke(e);D(n,t,s,r)},Pe=(e,t,s,r)=>{const n=ke(e);I(n,t,s,r)},ve=(e,t,s)=>{const r=(t,s)=>({get:le(e,t,s),set:me(e,t,s)});return Array.isArray(t)?t.reduce((e,t)=>(e[t]=r(t,s),e),{}):u(t)?Object.keys(t).reduce((e,n)=>(e[n]=r(t[n],s),e),{}):r(t,s)},Se=(e={})=>{"function"==typeof e.teddy&&e.teddy(V);for(const t of Object.keys(V.spaces||{})){"function"==typeof e.space&&e.space(t);for(const s of Object.keys(V.spaces[t].stores||{}))"function"==typeof e.store&&e.store(t,s)}},be=(e=(e=>e))=>({setStore:e(Y),makeState:e(Z),setState:e(te),applyState:e(ee),makeGetters:e(se),setGetters:e(re),makeActions:e(ne),setActions:e(oe),makeWatchers:e(ae),setWatchers:e(ce),exists:e(ie),reset:e(pe),run:e(ue),remove:e(fe),has:e(de),get:e(he),getter:e(le),set:e(ye),setter:e(me),sync:e(ve),push:e(ge),unshift:e(Pe)}),we=(e=K)=>(e in V.spaces||(V.spaces[e]={}),V.spaces[e]),_e=(e=K)=>({store:we(e),...be(t=>(...s)=>t({space:e,name:Q},...s))}),ke=e=>{const{space:t=K,name:s=Q}=X(e);return we(t),"stores"in V.spaces[t]||(V.spaces[t].stores={}),s in V.spaces[t].stores||(V.spaces[t].stores[s]={getters:{},actions:{},watchers:[],options:{},features:{}},ee(0,{},V.spaces[t].stores[s])),V.spaces[t].stores[s]},Ae=e=>({store:ke(e),...be(t=>(...s)=>t(e,...s))}),je=e=>{a(U,Ae(e))},Oe=()=>{c(R)},Ge=()=>{c(U)},Te=e=>{if(u(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?i(e):Object.keys(e).reduce((t,s)=>(t[s]=i(e[s]),t),{})}return i(e)};var $e=Object.freeze({__proto__:null,accessors:L,features:A,Teddy:R,TeddyStore:U,Teddies:V,setStore:Y,makeState:Z,applyState:ee,setState:te,makeGetters:se,setGetters:re,makeActions:ne,setActions:oe,makeWatchers:ae,setWatchers:ce,exists:ie,reset:pe,run:ue,remove:fe,has:de,get:he,getter:le,set:ye,setter:me,push:ge,unshift:Pe,sync:ve,setFeature:Se,mapMethods:be,getTeddy:we,useTeddy:_e,getStore:ke,useStore:Ae,provideTeddyStore:je,injectTeddy:Oe,injectTeddyStore:Ge,computed:Te});const We=e=>{e.prototype.$teddy=$e};export{V as Teddies,R as Teddy,U as TeddyStore,L as accessors,ee as applyState,Te as computed,ie as exists,A as features,he as get,ke as getStore,we as getTeddy,le as getter,de as has,Oe as injectTeddy,Ge as injectTeddyStore,We as install,ne as makeActions,se as makeGetters,Z as makeState,ae as makeWatchers,be as mapMethods,je as provideTeddyStore,ge as push,fe as remove,pe as reset,ue as run,ye as set,oe as setActions,Se as setFeature,re as setGetters,te as setState,Y as setStore,ce as setWatchers,me as setter,ve as sync,Pe as unshift,Ae as useStore,_e as useTeddy};
