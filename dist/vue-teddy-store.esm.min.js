/*!
  * vue-teddy-store v0.1.31
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
/*!
  * vue-teddy-store v0.1.31
  * (c) 2020 Gabin Desserprit
  * @license MIT
  */
import{isObject as t,makeGet as e,isValidKey as s,makeSet as r,makeHas as o}from"object-string-path";import{watch as n,reactive as i,isRef as a,ref as u,computed as c}from"@vue/composition-api";function h(e){if(!t(e)||t(e)&&!("value"in e))return!1;return"function"==typeof Object.getOwnPropertyDescriptor(e,"value").get}function l(t){return t.filter(Boolean).filter(t=>t.length>0).join(".")}function d(e,r,o){return s(r)&&(t(e)||Array.isArray(e))?h(e)&&"value"in e&&r in e.value?(e.value[r]=o,e.value[r]):(e[r]=o,e[r]):e&&null==r?(h(e)&&"value"in e?e.value=o:t(o)?Object.assign(e,o):e=o,e):void console.log("Couldn't not set "+r)}function p(e,r){return s(r)?h(e)?r in e.value?e.value[r]:e.value:t(e)||Array.isArray(e)?e[r]:void 0:e&&void 0===r?h(e)?e.value:e:void 0}function f(e,r){return!(!t(e)&&!Array.isArray(e))&&(!!s(r)&&(!!(h(e)&&e.value&&r in e.value)||(!(!e||!(r in e))||void 0)))}function y(t){return e=>{const[s,...r]=e||[];return s?(t(s),["_stores",s,"state",...r]):[]}}const g=(t=(t=>t))=>r({setProp:d,getProp:p,hasProp:f,afterGetSteps:y(t)}),v=(t=(t=>t))=>o({getProp:p,hasProp:f,afterGetSteps:y(t)}),_=(t=(t=>t))=>e({getProp:p,hasProp:f,afterGetSteps:y(t)}),m=r({setProp:d,getProp:p,hasProp:f}),w=o({getProp:p,hasProp:f}),b=e({getProp:p,hasProp:f});var P=Object.freeze({__proto__:null,makeTeddySet:g,makeTeddyHas:v,makeTeddyGet:_,set:m,has:w,get:b});const O=t=>"teddy:store:"+t;var S={handle({name:t,store:e}){const s=window.localStorage||global.localStorage||{};if(s){const r=s.getItem(O(t));r&&(e.state={...e.state,...JSON.parse(r)}),n(e.state,(e,r)=>{e!==r&&s.setItem(O(t),JSON.stringify(e))},{immediate:!0,deep:!0})}}},j={handle({store:t}){t._history=i([]),n(t.state,e=>{t._history.push(e)},{immediate:!0,deep:!0})}},x={handle({name:t,store:e}){window&&window.addEventListener("storage",s=>{s.key===O(t)&&(e.state=i({...e.state,...JSON.parse(s.newValue)}))})}},A=Object.freeze({__proto__:null,cache:S,history:j,sync:x});let $;class k extends Error{constructor(t){super(t),this.name="MissingStoreError"}}class G{constructor(){this._vueInstance=null,this._stores={},this._plugins=A,this.add("@",{state:{}})}add(t,e){const s=function(t,e=[]){return Object.keys(t).reduce((s,r)=>(e.includes(r)||(s[r]=t[r]),s),{})}(e=e||{},["state","getters","actions","watchers"]);this._stores[t]={state:E(e.state),...I(e.getters),...e.actions||{},...s},this[t]=this._stores[t];const r=[];Array.isArray(e.watchers)?r.push(...e.watchers):e.watcher&&r.push(e.watcher);for(let e of r)if("function"==typeof e)n(()=>this._stores[t].state.value,e,{deep:!0});else if(e&&"object"==typeof e&&"handler"in e){const{handler:s,path:r,paths:o=[],...i}=e;r?n(()=>_()(this,l([t,r])),s,{deep:!0,...i}):o.length>0?n(o.map(e=>()=>_()(this,l([t,e]))),s,{deep:!0,...i}):n(()=>this._stores[t].state.value,s,{deep:!0,...i})}return this}exists(t){return t in this._stores}remove(t){t in this&&delete this[t],t in this._stores&&delete this._stores[t]}reset(){for(let t in this._stores)this.remove(t)}use(t={}){return"function"==typeof t.install&&t.install(this),"function"==typeof t.handle&&Object.keys(this._stores).map(e=>t.handle.call(this,{name:e,store:this._stores[e]})),this}activate(t=[]){Array.isArray(t)||(t=[t]);for(let e of t)e in this._plugins&&this.use(this._plugins[e]);return this}attachTo(t){return this._vueInstance=t,this}install(...t){const e=this,[s]=t;if(s.version.startsWith("2")){if($&&s===$)return;$=s,Object.defineProperty(s.prototype,"$teddy",{get(){return e.attachTo(this)},configurable:!0})}else if(s.version.startsWith("3")){const[s,r]=t;s.provide("teddy",r),Object.defineProperty(s.config.globalProperties,"$teddy",{get(){return e.attachTo(this)},configurable:!0})}}get stores(){return this._stores}has(t,e){return T(t,e)}get(t,e){return M(t,e)}getter(t,e){return J(t,e)}set(t,e,s){return z(t,e,s)}setter(t,e){return N(t,e)}sync(t,e){return Y(t,e)}computed(t){return B(t)}}const E=(t={})=>a(t)?t:u(t),I=t=>(t=t||{},Object.keys(t).reduce((e,s)=>(h(t[s])?e[s]=t[s]:"function"==typeof t[s]&&(e[s]=B(t[s])),e),{})),T=(t,e)=>{const s=$.prototype.$teddy;return v(e=>{if(!s.exists(e))throw new k(`You're trying to use the method .has('${t}', context?) on a store which doesn't exists: '${e}'`)})(s,t,C(e,s))},M=(t,e)=>{const s=$.prototype.$teddy;return _(e=>{if(!s.exists(e))throw new k(`You're trying to use the method .get('${t}', context?) on a store which doesn't exists: '${e}'`)})(s,t,C(e,s))},z=(t,e,s)=>{const r=$.prototype.$teddy;g(e=>{if(!r.exists(e))throw new k(`You're trying to use the method .set('${t}', value, context?) on a store which doesn't exists: '${e}'`)})(r,t,e,C(s,r))},J=(t,e)=>function(){return M(t,e)},N=(t,e)=>function(s){z(t,s,e)},Y=(e,s)=>{const r=(t,e)=>({get:J(t,e),set:N(t,e)});return Array.isArray(e)?e.reduce((t,e)=>(t[e]=r(e,s),t),{}):t(e)?Object.keys(e).reduce((t,o)=>(t[o]=r(e[o],s),t),{}):r(e,s)},B=e=>{if(t(e)){const t="get"in e&&"function"==typeof e.get,s="set"in e&&"function"==typeof e.set;return t||s?c(e):Object.keys(e).reduce((t,s)=>(t[s]=c(e[s]),t),{})}return c(e)};function C(...e){return e.filter(Boolean).reduce((e,s)=>s instanceof G&&s._vueInstance?s._vueInstance:t(s)?s:e,{})}var W=Object.freeze({__proto__:null,MissingStoreError:k,default:G,createState:E,createGetters:I,has:T,get:M,set:z,getter:J,setter:N,sync:Y,computed:B,resolveContext:C});const{has:D,get:H,set:L,sync:V,computed:q,setter:F,getter:K,createGetters:Q,createState:R,MissingStoreError:U}=W;export default G;export{U as MissingStoreError,q as computed,Q as createGetters,R as createState,H as get,K as getter,D as has,P as objectAccess,L as set,F as setter,V as sync};
